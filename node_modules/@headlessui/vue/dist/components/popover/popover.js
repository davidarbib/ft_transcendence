import{defineComponent as k,inject as j,onUnmounted as ee,provide as G,ref as I,watchEffect as $,computed as C}from"vue";import{match as z}from"../../utils/match.js";import{render as T,Features as L}from"../../utils/render.js";import{useId as W}from"../../hooks/use-id.js";import{Keys as E}from"../../keyboard.js";import{getFocusableElements as V,Focus as w,focusIn as D,FocusResult as U,isFocusableElement as te,FocusableMode as oe}from"../../utils/focus-management.js";import{dom as n}from"../../utils/dom.js";import{useOpenClosedProvider as ne,State as B,useOpenClosed as J}from"../../internal/open-closed.js";import{useResolveButtonType as re}from"../../hooks/use-resolve-button-type.js";import{useOutsideClick as le}from"../../hooks/use-outside-click.js";import{getOwnerDocument as K}from"../../utils/owner.js";import{useEventListener as M}from"../../hooks/use-event-listener.js";var ae=(f=>(f[f.Open=0]="Open",f[f.Closed=1]="Closed",f))(ae||{});let Q=Symbol("PopoverContext");function H(c){let m=j(Q,null);if(m===null){let f=new Error(`<${c} /> is missing a parent <${pe.name} /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(f,H),f}return m}let X=Symbol("PopoverGroupContext");function Y(){return j(X,null)}let Z=Symbol("PopoverPanelContext");function ue(){return j(Z,null)}let pe=k({name:"Popover",props:{as:{type:[Object,String],default:"div"}},setup(c,{slots:m,attrs:f,expose:y}){var g;let e=`headlessui-popover-button-${W()}`,t=`headlessui-popover-panel-${W()}`,p=I(null);y({el:p,$el:p});let a=I(1),P=I(null),d=I(null),S=C(()=>K(p)),r={popoverState:a,buttonId:e,panelId:t,panel:d,button:P,togglePopover(){a.value=z(a.value,{[0]:1,[1]:0})},closePopover(){a.value!==1&&(a.value=1)},close(s){r.closePopover();let o=(()=>s?s instanceof HTMLElement?s:s.value instanceof HTMLElement?n(s):n(r.button):n(r.button))();o==null||o.focus()}};G(Q,r),ne(C(()=>z(a.value,{[0]:B.Open,[1]:B.Closed})));let l={buttonId:e,panelId:t,close(){r.closePopover()}},u=Y(),i=u==null?void 0:u.registerPopover;function O(){var s,o,v,b;return(b=u==null?void 0:u.isFocusWithinPopoverGroup())!=null?b:((s=S.value)==null?void 0:s.activeElement)&&(((o=n(P))==null?void 0:o.contains(S.value.activeElement))||((v=n(d))==null?void 0:v.contains(S.value.activeElement)))}return $(()=>i==null?void 0:i(l)),M((g=S.value)==null?void 0:g.defaultView,"focus",()=>{a.value===0&&(O()||!P||!d||r.closePopover())},!0),le([P,d],(s,o)=>{var v;a.value===0&&(r.closePopover(),te(o,oe.Loose)||(s.preventDefault(),(v=n(P))==null||v.focus()))}),()=>{let s={open:a.value===0,close:r.close};return T({props:{...c,ref:p},slot:s,slots:m,attrs:f,name:"Popover"})}}}),xe=k({name:"PopoverButton",props:{as:{type:[Object,String],default:"button"},disabled:{type:[Boolean],default:!1}},setup(c,{attrs:m,slots:f,expose:y}){var s;let e=H("PopoverButton"),t=C(()=>K(e.button));y({el:e.button,$el:e.button});let p=Y(),a=p==null?void 0:p.closeOthers,P=ue(),d=P===null?!1:P===e.panelId,S=I(null),r=I();M((s=t.value)==null?void 0:s.defaultView,"focus",()=>{var o;r.value=S.value,S.value=(o=t.value)==null?void 0:o.activeElement},!0);let l=I(null);d||$(()=>{e.button.value=l.value});let u=re(C(()=>({as:c.as,type:m.type})),l);function i(o){var v,b,x,h,R,F,A,N;if(d){if(e.popoverState.value===1)return;switch(o.key){case E.Space:case E.Enter:o.preventDefault(),(b=(v=o.target).click)==null||b.call(v),e.closePopover(),(x=n(e.button))==null||x.focus();break}}else switch(o.key){case E.Space:case E.Enter:o.preventDefault(),o.stopPropagation(),e.popoverState.value===1&&(a==null||a(e.buttonId)),e.togglePopover();break;case E.Escape:if(e.popoverState.value!==0)return a==null?void 0:a(e.buttonId);if(!n(e.button)||((h=t.value)==null?void 0:h.activeElement)&&!((R=n(e.button))!=null&&R.contains(t.value.activeElement)))return;o.preventDefault(),o.stopPropagation(),e.closePopover();break;case E.Tab:if(e.popoverState.value!==0||!e.panel||!e.button)return;if(o.shiftKey){if(!r.value||(F=n(e.button))!=null&&F.contains(r.value)||(A=n(e.panel))!=null&&A.contains(r.value))return;let q=V((N=t.value)==null?void 0:N.body),_=q.indexOf(r.value);if(q.indexOf(n(e.button))>_)return;o.preventDefault(),o.stopPropagation(),D(n(e.panel),w.Last)}else o.preventDefault(),o.stopPropagation(),D(n(e.panel),w.First);break}}function O(o){var v,b,x;if(!d&&(o.key===E.Space&&o.preventDefault(),e.popoverState.value===0&&!!e.panel&&!!e.button))switch(o.key){case E.Tab:if(!r.value||(v=n(e.button))!=null&&v.contains(r.value)||(b=n(e.panel))!=null&&b.contains(r.value))return;let h=V((x=t.value)==null?void 0:x.body),R=h.indexOf(r.value);if(h.indexOf(n(e.button))>R)return;o.preventDefault(),o.stopPropagation(),D(n(e.panel),w.Last);break}}function g(o){var v,b;c.disabled||(d?(e.closePopover(),(v=n(e.button))==null||v.focus()):(o.preventDefault(),o.stopPropagation(),e.popoverState.value===1&&(a==null||a(e.buttonId)),(b=n(e.button))==null||b.focus(),e.togglePopover()))}return()=>{let o={open:e.popoverState.value===0},v=d?{ref:l,type:u.value,onKeydown:i,onClick:g}:{ref:l,id:e.buttonId,type:u.value,"aria-expanded":c.disabled?void 0:e.popoverState.value===0,"aria-controls":n(e.panel)?e.panelId:void 0,disabled:c.disabled?!0:void 0,onKeydown:i,onKeyup:O,onClick:g};return T({props:{...c,...v},slot:o,attrs:m,slots:f,name:"PopoverButton"})}}}),Ce=k({name:"PopoverOverlay",props:{as:{type:[Object,String],default:"div"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0}},setup(c,{attrs:m,slots:f}){let y=H("PopoverOverlay"),e=`headlessui-popover-overlay-${W()}`,t=J(),p=C(()=>t!==null?t.value===B.Open:y.popoverState.value===0);function a(){y.closePopover()}return()=>{let P={open:y.popoverState.value===0};return T({props:{...c,...{id:e,"aria-hidden":!0,onClick:a}},slot:P,attrs:m,slots:f,features:L.RenderStrategy|L.Static,visible:p.value,name:"PopoverOverlay"})}}}),we=k({name:"PopoverPanel",props:{as:{type:[Object,String],default:"div"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},focus:{type:Boolean,default:!1}},setup(c,{attrs:m,slots:f,expose:y}){var S,r;let{focus:e}=c,t=H("PopoverPanel"),p=C(()=>K(t.panel));y({el:t.panel,$el:t.panel}),G(Z,t.panelId),ee(()=>{t.panel.value=null}),$(()=>{var u,i;if(!e||t.popoverState.value!==0||!t.panel)return;let l=(u=p.value)==null?void 0:u.activeElement;(i=n(t.panel))!=null&&i.contains(l)||D(n(t.panel),w.First)}),M((S=p.value)==null?void 0:S.defaultView,"keydown",l=>{var i,O,g;if(t.popoverState.value!==0||!n(t.panel)||l.key!==E.Tab||!((i=p.value)!=null&&i.activeElement)||!((O=n(t.panel))!=null&&O.contains(p.value.activeElement)))return;l.preventDefault();let u=D(n(t.panel),l.shiftKey?w.Previous:w.Next);if(u===U.Underflow)return(g=n(t.button))==null?void 0:g.focus();if(u===U.Overflow){if(!n(t.button))return;let s=V(p.value.body),o=s.indexOf(n(t.button)),v=s.splice(o+1).filter(b=>{var x;return!((x=n(t.panel))!=null&&x.contains(b))});D(v,w.First)===U.Error&&D(p.value.body,w.First)}}),M((r=p.value)==null?void 0:r.defaultView,"focus",()=>{var l,u;!e||t.popoverState.value===0&&(!n(t.panel)||((l=p.value)==null?void 0:l.activeElement)&&((u=n(t.panel))==null?void 0:u.contains(p.value.activeElement))||t.closePopover())},!0);let a=J(),P=C(()=>a!==null?a.value===B.Open:t.popoverState.value===0);function d(l){var u,i;switch(l.key){case E.Escape:if(t.popoverState.value!==0||!n(t.panel)||p.value&&!((u=n(t.panel))!=null&&u.contains(p.value.activeElement)))return;l.preventDefault(),l.stopPropagation(),t.closePopover(),(i=n(t.button))==null||i.focus();break}}return()=>{let l={open:t.popoverState.value===0,close:t.close},u={ref:t.panel,id:t.panelId,onKeydown:d};return T({props:{...c,...u},slot:l,attrs:m,slots:f,features:L.RenderStrategy|L.Static,visible:P.value,name:"PopoverPanel"})}}}),De=k({name:"PopoverGroup",props:{as:{type:[Object,String],default:"div"}},setup(c,{attrs:m,slots:f,expose:y}){let e=I(null),t=I([]),p=C(()=>K(e));y({el:e,$el:e});function a(r){let l=t.value.indexOf(r);l!==-1&&t.value.splice(l,1)}function P(r){return t.value.push(r),()=>{a(r)}}function d(){var u;let r=p.value;if(!r)return!1;let l=r.activeElement;return(u=n(e))!=null&&u.contains(l)?!0:t.value.some(i=>{var O,g;return((O=r.getElementById(i.buttonId))==null?void 0:O.contains(l))||((g=r.getElementById(i.panelId))==null?void 0:g.contains(l))})}function S(r){for(let l of t.value)l.buttonId!==r&&l.close()}return G(X,{registerPopover:P,unregisterPopover:a,isFocusWithinPopoverGroup:d,closeOthers:S}),()=>T({props:{...c,...{ref:e}},slot:{},attrs:m,slots:f,name:"PopoverGroup"})}});export{pe as Popover,xe as PopoverButton,De as PopoverGroup,Ce as PopoverOverlay,we as PopoverPanel};
