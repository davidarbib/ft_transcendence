import{Fragment as U,computed as g,defineComponent as M,h as j,inject as $,nextTick as w,onMounted as A,onUnmounted as z,provide as H,ref as y,toRaw as k,watch as Q,watchEffect as q}from"vue";import{Features as B,render as I,omit as K,compact as W}from"../../utils/render.js";import{useId as E}from"../../hooks/use-id.js";import{Keys as c}from"../../keyboard.js";import{calculateActiveIndex as _,Focus as b}from"../../utils/calculate-active-index.js";import{dom as v}from"../../utils/dom.js";import{useOpenClosed as G,State as F,useOpenClosedProvider as J}from"../../internal/open-closed.js";import{match as C}from"../../utils/match.js";import{useResolveButtonType as X}from"../../hooks/use-resolve-button-type.js";import{FocusableMode as Y,isFocusableElement as Z,sortByDomNode as ee}from"../../utils/focus-management.js";import{useOutsideClick as te}from"../../hooks/use-outside-click.js";import{VisuallyHidden as oe}from"../../internal/visually-hidden.js";import{objectToFormEntries as ie}from"../../utils/form.js";var ae=(n=>(n[n.Open=0]="Open",n[n.Closed=1]="Closed",n))(ae||{}),le=(n=>(n[n.Single=0]="Single",n[n.Multi=1]="Multi",n))(le||{}),ne=(n=>(n[n.Pointer=0]="Pointer",n[n.Other=1]="Other",n))(ne||{});function ue(o){requestAnimationFrame(()=>requestAnimationFrame(o))}let N=Symbol("ListboxContext");function P(o){let x=$(N,null);if(x===null){let n=new Error(`<${o} /> is missing a parent <Listbox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(n,P),n}return x}let De=M({name:"Listbox",emits:{"update:modelValue":o=>!0},props:{as:{type:[Object,String],default:"template"},disabled:{type:[Boolean],default:!1},horizontal:{type:[Boolean],default:!1},modelValue:{type:[Object,String,Number,Boolean]},name:{type:String,optional:!0},multiple:{type:[Boolean],default:!1}},setup(o,{slots:x,attrs:n,emit:S}){let e=y(1),p=y(null),d=y(null),m=y(null),r=y([]),O=y(""),t=y(null),a=y(1);function D(i=l=>l){let l=t.value!==null?r.value[t.value]:null,u=ee(i(r.value.slice()),R=>v(R.dataRef.domRef)),f=l?u.indexOf(l):null;return f===-1&&(f=null),{options:u,activeOptionIndex:f}}let L=g(()=>o.modelValue),T=g(()=>o.multiple?1:0),s={listboxState:e,value:L,mode:T,orientation:g(()=>o.horizontal?"horizontal":"vertical"),labelRef:p,buttonRef:d,optionsRef:m,disabled:g(()=>o.disabled),options:r,searchQuery:O,activeOptionIndex:t,activationTrigger:a,closeListbox(){o.disabled||e.value!==1&&(e.value=1,t.value=null)},openListbox(){o.disabled||e.value!==0&&(e.value=0)},goToOption(i,l,u){if(o.disabled||e.value===1)return;let f=D(),R=_(i===b.Specific?{focus:b.Specific,id:l}:{focus:i},{resolveItems:()=>f.options,resolveActiveIndex:()=>f.activeOptionIndex,resolveId:h=>h.id,resolveDisabled:h=>h.dataRef.disabled});O.value="",t.value=R,a.value=u!=null?u:1,r.value=f.options},search(i){if(o.disabled||e.value===1)return;let u=O.value!==""?0:1;O.value+=i.toLowerCase();let R=(t.value!==null?r.value.slice(t.value+u).concat(r.value.slice(0,t.value+u)):r.value).find(V=>V.dataRef.textValue.startsWith(O.value)&&!V.dataRef.disabled),h=R?r.value.indexOf(R):-1;h===-1||h===t.value||(t.value=h,a.value=1)},clearSearch(){o.disabled||e.value!==1&&O.value!==""&&(O.value="")},registerOption(i,l){let u=D(f=>[...f,{id:i,dataRef:l}]);r.value=u.options,t.value=u.activeOptionIndex},unregisterOption(i){let l=D(u=>{let f=u.findIndex(R=>R.id===i);return f!==-1&&u.splice(f,1),u});r.value=l.options,t.value=l.activeOptionIndex,a.value=1},select(i){o.disabled||S("update:modelValue",C(T.value,{[0]:()=>i,[1]:()=>{let l=k(s.value.value).slice(),u=k(i),f=l.indexOf(u);return f===-1?l.push(u):l.splice(f,1),l}}))}};return te([d,m],(i,l)=>{var u;e.value===0&&(s.closeListbox(),Z(l,Y.Loose)||(i.preventDefault(),(u=v(d))==null||u.focus()))}),H(N,s),J(g(()=>C(e.value,{[0]:F.Open,[1]:F.Closed}))),()=>{let{name:i,modelValue:l,disabled:u,...f}=o,R={open:e.value===0,disabled:u};return j(U,[...i!=null&&l!=null?ie({[i]:l}).map(([h,V])=>j(oe,W({key:h,as:"input",type:"hidden",hidden:!0,readOnly:!0,name:h,value:V}))):[],I({props:K(f,["onUpdate:modelValue","horizontal","multiple"]),slot:R,slots:x,attrs:n,name:"Listbox"})])}}}),Te=M({name:"ListboxLabel",props:{as:{type:[Object,String],default:"label"}},setup(o,{attrs:x,slots:n}){let S=P("ListboxLabel"),e=`headlessui-listbox-label-${E()}`;function p(){var d;(d=v(S.buttonRef))==null||d.focus({preventScroll:!0})}return()=>{let d={open:S.listboxState.value===0,disabled:S.disabled.value},m={id:e,ref:S.labelRef,onClick:p};return I({props:{...o,...m},slot:d,attrs:x,slots:n,name:"ListboxLabel"})}}}),we=M({name:"ListboxButton",props:{as:{type:[Object,String],default:"button"}},setup(o,{attrs:x,slots:n,expose:S}){let e=P("ListboxButton"),p=`headlessui-listbox-button-${E()}`;S({el:e.buttonRef,$el:e.buttonRef});function d(t){switch(t.key){case c.Space:case c.Enter:case c.ArrowDown:t.preventDefault(),e.openListbox(),w(()=>{var a;(a=v(e.optionsRef))==null||a.focus({preventScroll:!0}),e.value.value||e.goToOption(b.First)});break;case c.ArrowUp:t.preventDefault(),e.openListbox(),w(()=>{var a;(a=v(e.optionsRef))==null||a.focus({preventScroll:!0}),e.value.value||e.goToOption(b.Last)});break}}function m(t){switch(t.key){case c.Space:t.preventDefault();break}}function r(t){e.disabled.value||(e.listboxState.value===0?(e.closeListbox(),w(()=>{var a;return(a=v(e.buttonRef))==null?void 0:a.focus({preventScroll:!0})})):(t.preventDefault(),e.openListbox(),ue(()=>{var a;return(a=v(e.optionsRef))==null?void 0:a.focus({preventScroll:!0})})))}let O=X(g(()=>({as:o.as,type:x.type})),e.buttonRef);return()=>{var D,L;let t={open:e.listboxState.value===0,disabled:e.disabled.value},a={ref:e.buttonRef,id:p,type:O.value,"aria-haspopup":!0,"aria-controls":(D=v(e.optionsRef))==null?void 0:D.id,"aria-expanded":e.disabled.value?void 0:e.listboxState.value===0,"aria-labelledby":e.labelRef.value?[(L=v(e.labelRef))==null?void 0:L.id,p].join(" "):void 0,disabled:e.disabled.value===!0?!0:void 0,onKeydown:d,onKeyup:m,onClick:r};return I({props:{...o,...a},slot:t,attrs:x,slots:n,name:"ListboxButton"})}}}),ke=M({name:"ListboxOptions",props:{as:{type:[Object,String],default:"ul"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0}},setup(o,{attrs:x,slots:n,expose:S}){let e=P("ListboxOptions"),p=`headlessui-listbox-options-${E()}`,d=y(null);S({el:e.optionsRef,$el:e.optionsRef});function m(t){switch(d.value&&clearTimeout(d.value),t.key){case c.Space:if(e.searchQuery.value!=="")return t.preventDefault(),t.stopPropagation(),e.search(t.key);case c.Enter:if(t.preventDefault(),t.stopPropagation(),e.activeOptionIndex.value!==null){let a=e.options.value[e.activeOptionIndex.value];e.select(a.dataRef.value)}e.mode.value===0&&(e.closeListbox(),w(()=>{var a;return(a=v(e.buttonRef))==null?void 0:a.focus({preventScroll:!0})}));break;case C(e.orientation.value,{vertical:c.ArrowDown,horizontal:c.ArrowRight}):return t.preventDefault(),t.stopPropagation(),e.goToOption(b.Next);case C(e.orientation.value,{vertical:c.ArrowUp,horizontal:c.ArrowLeft}):return t.preventDefault(),t.stopPropagation(),e.goToOption(b.Previous);case c.Home:case c.PageUp:return t.preventDefault(),t.stopPropagation(),e.goToOption(b.First);case c.End:case c.PageDown:return t.preventDefault(),t.stopPropagation(),e.goToOption(b.Last);case c.Escape:t.preventDefault(),t.stopPropagation(),e.closeListbox(),w(()=>{var a;return(a=v(e.buttonRef))==null?void 0:a.focus({preventScroll:!0})});break;case c.Tab:t.preventDefault(),t.stopPropagation();break;default:t.key.length===1&&(e.search(t.key),d.value=setTimeout(()=>e.clearSearch(),350));break}}let r=G(),O=g(()=>r!==null?r.value===F.Open:e.listboxState.value===0);return()=>{var L,T,s,i;let t={open:e.listboxState.value===0},a={"aria-activedescendant":e.activeOptionIndex.value===null||(L=e.options.value[e.activeOptionIndex.value])==null?void 0:L.id,"aria-multiselectable":e.mode.value===1?!0:void 0,"aria-labelledby":(i=(T=v(e.labelRef))==null?void 0:T.id)!=null?i:(s=v(e.buttonRef))==null?void 0:s.id,"aria-orientation":e.orientation.value,id:p,onKeydown:m,role:"listbox",tabIndex:0,ref:e.optionsRef};return I({props:{...o,...a},slot:t,attrs:x,slots:n,features:B.RenderStrategy|B.Static,visible:O.value,name:"ListboxOptions"})}}}),Ce=M({name:"ListboxOption",props:{as:{type:[Object,String],default:"li"},value:{type:[Object,String,Number,Boolean]},disabled:{type:Boolean,default:!1}},setup(o,{slots:x,attrs:n,expose:S}){let e=P("ListboxOption"),p=`headlessui-listbox-option-${E()}`,d=y(null);S({el:d,$el:d});let m=g(()=>e.activeOptionIndex.value!==null?e.options.value[e.activeOptionIndex.value].id===p:!1),r=g(()=>C(e.mode.value,{[0]:()=>k(e.value.value)===k(o.value),[1]:()=>k(e.value.value).includes(k(o.value))})),O=g(()=>C(e.mode.value,{[1]:()=>{var i;let s=k(e.value.value);return((i=e.options.value.find(l=>s.includes(l.dataRef.value)))==null?void 0:i.id)===p},[0]:()=>r.value})),t=g(()=>({disabled:o.disabled,value:o.value,textValue:"",domRef:d}));A(()=>{var i,l;let s=(l=(i=v(d))==null?void 0:i.textContent)==null?void 0:l.toLowerCase().trim();s!==void 0&&(t.value.textValue=s)}),A(()=>e.registerOption(p,t)),z(()=>e.unregisterOption(p)),A(()=>{Q([e.listboxState,r],()=>{e.listboxState.value===0&&(!r.value||C(e.mode.value,{[1]:()=>{O.value&&e.goToOption(b.Specific,p)},[0]:()=>{e.goToOption(b.Specific,p)}}))},{immediate:!0})}),q(()=>{e.listboxState.value===0&&(!m.value||e.activationTrigger.value!==0&&w(()=>{var s,i;return(i=(s=v(d))==null?void 0:s.scrollIntoView)==null?void 0:i.call(s,{block:"nearest"})}))});function a(s){if(o.disabled)return s.preventDefault();e.select(o.value),e.mode.value===0&&(e.closeListbox(),w(()=>{var i;return(i=v(e.buttonRef))==null?void 0:i.focus({preventScroll:!0})}))}function D(){if(o.disabled)return e.goToOption(b.Nothing);e.goToOption(b.Specific,p)}function L(){o.disabled||m.value||e.goToOption(b.Specific,p,0)}function T(){o.disabled||!m.value||e.goToOption(b.Nothing)}return()=>{let{disabled:s}=o,i={active:m.value,selected:r.value,disabled:s},l={id:p,ref:d,role:"option",tabIndex:s===!0?void 0:-1,"aria-disabled":s===!0?!0:void 0,"aria-selected":r.value===!0?r.value:void 0,disabled:void 0,onClick:a,onFocus:D,onPointermove:L,onMousemove:L,onPointerleave:T,onMouseleave:T};return I({props:{...K(o,["value","disabled"]),...l},slot:i,attrs:n,slots:x,name:"ListboxOption"})}}});export{De as Listbox,we as ListboxButton,Te as ListboxLabel,Ce as ListboxOption,ke as ListboxOptions};
