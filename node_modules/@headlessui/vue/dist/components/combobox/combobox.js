import{Fragment as J,computed as g,defineComponent as k,h as $,inject as W,nextTick as M,onMounted as z,onUnmounted as G,provide as Q,ref as D,toRaw as x,watch as U,watchEffect as N}from"vue";import{Features as B,render as E,omit as H,compact as X}from"../../utils/render.js";import{useId as F}from"../../hooks/use-id.js";import{Keys as y}from"../../keyboard.js";import{calculateActiveIndex as Y,Focus as R}from"../../utils/calculate-active-index.js";import{dom as I}from"../../utils/dom.js";import{useOpenClosed as Z,State as K,useOpenClosedProvider as ee}from"../../internal/open-closed.js";import{match as V}from"../../utils/match.js";import{useResolveButtonType as te}from"../../hooks/use-resolve-button-type.js";import{useTreeWalker as oe}from"../../hooks/use-tree-walker.js";import{sortByDomNode as ne}from"../../utils/focus-management.js";import{useOutsideClick as le}from"../../hooks/use-outside-click.js";import{VisuallyHidden as ae}from"../../internal/visually-hidden.js";import{objectToFormEntries as ie}from"../../utils/form.js";var ue=(i=>(i[i.Open=0]="Open",i[i.Closed=1]="Closed",i))(ue||{}),re=(i=>(i[i.Single=0]="Single",i[i.Multi=1]="Multi",i))(re||{}),se=(i=>(i[i.Pointer=0]="Pointer",i[i.Other=1]="Other",i))(se||{});let _=Symbol("ComboboxContext");function A(n){let O=W(_,null);if(O===null){let i=new Error(`<${n} /> is missing a parent <Combobox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(i,A),i}return O}let we=k({name:"Combobox",emits:{"update:modelValue":n=>!0},props:{as:{type:[Object,String],default:"template"},disabled:{type:[Boolean],default:!1},modelValue:{type:[Object,String,Number,Boolean]},name:{type:String},nullable:{type:Boolean,default:!1},multiple:{type:[Boolean],default:!1}},setup(n,{slots:O,attrs:i,emit:C}){let e=D(1),t=D(null),d=D(null),S=D(null),c=D(null),b=D({static:!1,hold:!1}),o=D([]),p=D(null),v=D(1),h=D(!1);function f(a=s=>s){let s=p.value!==null?o.value[p.value]:null,u=ne(a(o.value.slice()),m=>I(m.dataRef.domRef)),l=s?u.indexOf(s):null;return l===-1&&(l=null),{options:u,activeOptionIndex:l}}let P=g(()=>n.modelValue),w=g(()=>n.multiple?1:0),L=g(()=>n.nullable),r={comboboxState:e,value:P,mode:w,nullable:L,inputRef:d,labelRef:t,buttonRef:S,optionsRef:c,disabled:g(()=>n.disabled),options:o,change(a){C("update:modelValue",a)},activeOptionIndex:g(()=>{if(h.value&&p.value===null&&o.value.length>0){let a=o.value.findIndex(s=>!s.dataRef.disabled);if(a!==-1)return a}return p.value}),activationTrigger:v,inputPropsRef:D({displayValue:void 0}),optionsPropsRef:b,closeCombobox(){h.value=!1,!n.disabled&&e.value!==1&&(e.value=1,p.value=null)},openCombobox(){if(h.value=!0,n.disabled||e.value===0)return;let a=o.value.findIndex(s=>{let u=x(s.dataRef.value);return V(w.value,{[0]:()=>x(r.value.value)===x(u),[1]:()=>x(r.value.value).includes(x(u))})});a!==-1&&(p.value=a),e.value=0},goToOption(a,s,u){if(h.value=!1,n.disabled||c.value&&!b.value.static&&e.value===1)return;let l=f();if(l.activeOptionIndex===null){let T=l.options.findIndex(j=>!j.dataRef.disabled);T!==-1&&(l.activeOptionIndex=T)}let m=Y(a===R.Specific?{focus:R.Specific,id:s}:{focus:a},{resolveItems:()=>l.options,resolveActiveIndex:()=>l.activeOptionIndex,resolveId:T=>T.id,resolveDisabled:T=>T.dataRef.disabled});p.value=m,v.value=u!=null?u:1,o.value=l.options},syncInputValue(){var u;let a=r.value.value;if(!I(r.inputRef))return;let s=r.inputPropsRef.value.displayValue;typeof s=="function"?r.inputRef.value.value=(u=s(a))!=null?u:"":typeof a=="string"?r.inputRef.value.value=a:r.inputRef.value.value=""},selectOption(a){let s=o.value.find(l=>l.id===a);if(!s)return;let{dataRef:u}=s;C("update:modelValue",V(w.value,{[0]:()=>u.value,[1]:()=>{let l=x(r.value.value).slice(),m=x(u.value),T=l.indexOf(m);return T===-1?l.push(m):l.splice(T,1),l}})),r.syncInputValue()},selectActiveOption(){if(r.activeOptionIndex.value===null)return;let{dataRef:a,id:s}=o.value[r.activeOptionIndex.value];C("update:modelValue",V(w.value,{[0]:()=>a.value,[1]:()=>{let u=x(r.value.value).slice(),l=x(a.value),m=u.indexOf(l);return m===-1?u.push(l):u.splice(m,1),u}})),r.syncInputValue(),r.goToOption(R.Specific,s)},registerOption(a,s){let u={id:a,dataRef:s},l=f(m=>[...m,u]);if(p.value===null){let m=s.value.value;V(w.value,{[0]:()=>x(r.value.value)===x(m),[1]:()=>x(r.value.value).includes(x(m))})&&(l.activeOptionIndex=l.options.indexOf(u))}o.value=l.options,p.value=l.activeOptionIndex,v.value=1},unregisterOption(a){let s=f(u=>{let l=u.findIndex(m=>m.id===a);return l!==-1&&u.splice(l,1),u});o.value=s.options,p.value=s.activeOptionIndex,v.value=1}};le([d,S,c],()=>{e.value===0&&r.closeCombobox()}),U([r.value,r.inputRef],()=>r.syncInputValue(),{immediate:!0}),U(r.comboboxState,a=>{a===1&&r.syncInputValue()},{immediate:!0}),Q(_,r),ee(g(()=>V(e.value,{[0]:K.Open,[1]:K.Closed})));let q=g(()=>r.activeOptionIndex.value===null?null:o.value[r.activeOptionIndex.value].dataRef.value);return()=>{let{name:a,modelValue:s,disabled:u,...l}=n,m={open:e.value===0,disabled:u,activeIndex:r.activeOptionIndex.value,activeOption:q.value};return $(J,[...a!=null&&s!=null?ie({[a]:s}).map(([T,j])=>$(ae,X({key:T,as:"input",type:"hidden",hidden:!0,readOnly:!0,name:T,value:j}))):[],E({props:H(l,["nullable","multiple","onUpdate:modelValue"]),slot:m,slots:O,attrs:i,name:"Combobox"})])}}}),Me=k({name:"ComboboxLabel",props:{as:{type:[Object,String],default:"label"}},setup(n,{attrs:O,slots:i}){let C=A("ComboboxLabel"),e=`headlessui-combobox-label-${F()}`;function t(){var d;(d=I(C.inputRef))==null||d.focus({preventScroll:!0})}return()=>{let d={open:C.comboboxState.value===0,disabled:C.disabled.value},S={id:e,ref:C.labelRef,onClick:t};return E({props:{...n,...S},slot:d,attrs:O,slots:i,name:"ComboboxLabel"})}}}),Ve=k({name:"ComboboxButton",props:{as:{type:[Object,String],default:"button"}},setup(n,{attrs:O,slots:i,expose:C}){let e=A("ComboboxButton"),t=`headlessui-combobox-button-${F()}`;C({el:e.buttonRef,$el:e.buttonRef});function d(b){e.disabled.value||(e.comboboxState.value===0?e.closeCombobox():(b.preventDefault(),e.openCombobox()),M(()=>{var o;return(o=I(e.inputRef))==null?void 0:o.focus({preventScroll:!0})}))}function S(b){switch(b.key){case y.ArrowDown:b.preventDefault(),b.stopPropagation(),e.comboboxState.value===1&&(e.openCombobox(),M(()=>{e.value.value||e.goToOption(R.First)})),M(()=>{var o;return(o=e.inputRef.value)==null?void 0:o.focus({preventScroll:!0})});return;case y.ArrowUp:b.preventDefault(),b.stopPropagation(),e.comboboxState.value===1&&(e.openCombobox(),M(()=>{e.value.value||e.goToOption(R.Last)})),M(()=>{var o;return(o=e.inputRef.value)==null?void 0:o.focus({preventScroll:!0})});return;case y.Escape:b.preventDefault(),e.optionsRef.value&&!e.optionsPropsRef.value.static&&b.stopPropagation(),e.closeCombobox(),M(()=>{var o;return(o=e.inputRef.value)==null?void 0:o.focus({preventScroll:!0})});return}}let c=te(g(()=>({as:n.as,type:O.type})),e.buttonRef);return()=>{var p,v;let b={open:e.comboboxState.value===0,disabled:e.disabled.value},o={ref:e.buttonRef,id:t,type:c.value,tabindex:"-1","aria-haspopup":!0,"aria-controls":(p=I(e.optionsRef))==null?void 0:p.id,"aria-expanded":e.disabled.value?void 0:e.comboboxState.value===0,"aria-labelledby":e.labelRef.value?[(v=I(e.labelRef))==null?void 0:v.id,t].join(" "):void 0,disabled:e.disabled.value===!0?!0:void 0,onKeydown:S,onClick:d};return E({props:{...n,...o},slot:b,attrs:O,slots:i,name:"ComboboxButton"})}}}),ke=k({name:"ComboboxInput",props:{as:{type:[Object,String],default:"input"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},displayValue:{type:Function}},emits:{change:n=>!0},setup(n,{emit:O,attrs:i,slots:C,expose:e}){let t=A("ComboboxInput"),d=`headlessui-combobox-input-${F()}`;t.inputPropsRef=g(()=>n),e({el:t.inputRef,$el:t.inputRef});function S(o){switch(o.key){case y.Backspace:case y.Delete:if(t.mode.value!==0||!t.nullable.value)return;let p=o.currentTarget;requestAnimationFrame(()=>{if(p.value===""){t.change(null);let v=I(t.optionsRef);v&&(v.scrollTop=0),t.goToOption(R.Nothing)}});break;case y.Enter:if(t.comboboxState.value!==0)return;if(o.preventDefault(),o.stopPropagation(),t.activeOptionIndex.value===null){t.closeCombobox();return}t.selectActiveOption(),t.mode.value===0&&t.closeCombobox();break;case y.ArrowDown:return o.preventDefault(),o.stopPropagation(),V(t.comboboxState.value,{[0]:()=>t.goToOption(R.Next),[1]:()=>{t.openCombobox(),M(()=>{t.value.value||t.goToOption(R.First)})}});case y.ArrowUp:return o.preventDefault(),o.stopPropagation(),V(t.comboboxState.value,{[0]:()=>t.goToOption(R.Previous),[1]:()=>{t.openCombobox(),M(()=>{t.value.value||t.goToOption(R.Last)})}});case y.Home:case y.PageUp:return o.preventDefault(),o.stopPropagation(),t.goToOption(R.First);case y.End:case y.PageDown:return o.preventDefault(),o.stopPropagation(),t.goToOption(R.Last);case y.Escape:o.preventDefault(),t.optionsRef.value&&!t.optionsPropsRef.value.static&&o.stopPropagation(),t.closeCombobox();break;case y.Tab:t.selectActiveOption(),t.closeCombobox();break}}function c(o){O("change",o)}function b(o){t.openCombobox(),O("change",o)}return()=>{var h,f,P,w,L;let o={open:t.comboboxState.value===0},p={"aria-controls":(h=t.optionsRef.value)==null?void 0:h.id,"aria-expanded":t.disabled?void 0:t.comboboxState.value===0,"aria-activedescendant":t.activeOptionIndex.value===null||(f=t.options.value[t.activeOptionIndex.value])==null?void 0:f.id,"aria-multiselectable":t.mode.value===1?!0:void 0,"aria-labelledby":(L=(P=I(t.labelRef))==null?void 0:P.id)!=null?L:(w=I(t.buttonRef))==null?void 0:w.id,id:d,onKeydown:S,onChange:c,onInput:b,role:"combobox",type:"text",tabIndex:0,ref:t.inputRef},v=H(n,["displayValue"]);return E({props:{...v,...p},slot:o,attrs:i,slots:C,features:B.RenderStrategy|B.Static,name:"ComboboxInput"})}}}),Ee=k({name:"ComboboxOptions",props:{as:{type:[Object,String],default:"ul"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},hold:{type:[Boolean],default:!1}},setup(n,{attrs:O,slots:i,expose:C}){let e=A("ComboboxOptions"),t=`headlessui-combobox-options-${F()}`;C({el:e.optionsRef,$el:e.optionsRef}),N(()=>{e.optionsPropsRef.value.static=n.static}),N(()=>{e.optionsPropsRef.value.hold=n.hold});let d=Z(),S=g(()=>d!==null?d.value===K.Open:e.comboboxState.value===0);return oe({container:g(()=>I(e.optionsRef)),enabled:g(()=>e.comboboxState.value===0),accept(c){return c.getAttribute("role")==="option"?NodeFilter.FILTER_REJECT:c.hasAttribute("role")?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT},walk(c){c.setAttribute("role","none")}}),()=>{var p,v,h,f;let c={open:e.comboboxState.value===0},b={"aria-activedescendant":e.activeOptionIndex.value===null||(p=e.options.value[e.activeOptionIndex.value])==null?void 0:p.id,"aria-labelledby":(f=(v=I(e.labelRef))==null?void 0:v.id)!=null?f:(h=I(e.buttonRef))==null?void 0:h.id,id:t,ref:e.optionsRef,role:"listbox"},o=H(n,["hold"]);return E({props:{...o,...b},slot:c,attrs:O,slots:i,features:B.RenderStrategy|B.Static,visible:S.value,name:"ComboboxOptions"})}}}),Ae=k({name:"ComboboxOption",props:{as:{type:[Object,String],default:"li"},value:{type:[Object,String,Number,Boolean]},disabled:{type:Boolean,default:!1}},setup(n,{slots:O,attrs:i,expose:C}){let e=A("ComboboxOption"),t=`headlessui-combobox-option-${F()}`,d=D(null);C({el:d,$el:d});let S=g(()=>e.activeOptionIndex.value!==null?e.options.value[e.activeOptionIndex.value].id===t:!1),c=g(()=>V(e.mode.value,{[0]:()=>x(e.value.value)===x(n.value),[1]:()=>x(e.value.value).includes(x(n.value))})),b=g(()=>({disabled:n.disabled,value:n.value,domRef:d}));z(()=>e.registerOption(t,b)),G(()=>e.unregisterOption(t)),N(()=>{e.comboboxState.value===0&&(!S.value||e.activationTrigger.value!==0&&M(()=>{var f,P;return(P=(f=I(d))==null?void 0:f.scrollIntoView)==null?void 0:P.call(f,{block:"nearest"})}))});function o(f){if(n.disabled)return f.preventDefault();e.selectOption(t),e.mode.value===0&&(e.closeCombobox(),M(()=>{var P;return(P=I(e.inputRef))==null?void 0:P.focus({preventScroll:!0})}))}function p(){if(n.disabled)return e.goToOption(R.Nothing);e.goToOption(R.Specific,t)}function v(){n.disabled||S.value||e.goToOption(R.Specific,t,0)}function h(){n.disabled||!S.value||e.optionsPropsRef.value.hold||e.goToOption(R.Nothing)}return()=>{let{disabled:f}=n,P={active:S.value,selected:c.value,disabled:f},w={id:t,ref:d,role:"option",tabIndex:f===!0?void 0:-1,"aria-disabled":f===!0?!0:void 0,"aria-selected":c.value===!0?c.value:void 0,disabled:void 0,onClick:o,onFocus:p,onPointermove:v,onMousemove:v,onPointerleave:h,onMouseleave:h};return E({props:{...n,...w},slot:P,attrs:i,slots:O,name:"ComboboxOption"})}}});export{we as Combobox,Ve as ComboboxButton,ke as ComboboxInput,Me as ComboboxLabel,Ae as ComboboxOption,Ee as ComboboxOptions};
